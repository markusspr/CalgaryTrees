<!DOCTYPE html>
<html>
<head>
<title>Calgary Trees Map</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
#map { width: 100%; height: 100vh; }
.bearing-arrow { 
    transform-origin: center center; 
    transition: transform 0.1s linear; /* smooth rotation */
}
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const radius = 250; // meters
const map = L.map("map").setView([51.045, -114.071], 16); // fallback

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

function loadTrees(lat, lon) {
    const url = `https://data.calgary.ca/resource/tfs4-3wwa.json?$$app_token=8Y6BJoOEjSnxgyvODpDnOR5Yj&$where=within_circle(point, ${lat}, ${lon}, ${radius})&$limit=200`;
    fetch(url)
        .then(resp => resp.json())
        .then(data => {
            if (!Array.isArray(data)) return console.error("API error", data);
            data.forEach(tree => {
                if (tree.point && tree.point.coordinates) {
                    const [treeLon, treeLat] = tree.point.coordinates;
                    L.circleMarker([treeLat, treeLon], {
                        radius: 5,
                        color: "green",
                        fillOpacity: 0.7
                    }).addTo(map)
                    .bindPopup(`<b>${tree.common_name || tree.scientific_name || "Unknown"}</b><br>Asset ID: ${tree.asset_id || "N/A"}<br>Scientific Name: ${tree.scientific_name || "N/A"}<br>DBH (cm): ${tree.dbh_cm || "N/A"}<br>Mature Size: ${tree.mature_size || "N/A"}<br>Condition: ${tree.tree_condition_rating_perc || "N/A"}%`);
                }
            });
        }).catch(err => console.error("Error loading data", err));
}

if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        // Create a divIcon with arrow
        const userIcon = L.divIcon({
            className: 'bearing-arrow',
            html: `<svg width="40" height="40" viewBox="0 0 30 30"><polygon points="15,0 25,30 15,25 5,30" style="fill:red"/></svg>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const userMarker = L.marker([userLat, userLon], { icon: userIcon }).addTo(map).bindPopup("You are here").openPopup();
        map.setView([userLat, userLon], 16);

        loadTrees(userLat, userLon);

        // Handle device orientation for smooth heading
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientationabsolute', event => {
                let alpha = event.alpha;
                if (alpha === null) return;

                // Convert to Leaflet rotation: Google Maps style (0 = North)
                const rotation = 360 - alpha; // flip to match compass heading
                userMarker.getElement().style.transform = `rotate(${rotation}deg)`;
            }, true);
        }
    }, err => {
        console.warn("Geolocation failed:", err.message);
        loadTrees(51.045, -114.071);
    }, { enableHighAccuracy: true });
} else {
    loadTrees(51.045, -114.071);
}
</script>
</body>
</html>
