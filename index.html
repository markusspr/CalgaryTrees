<!DOCTYPE html>
<html>
<head>
  <title>Calgary Trees Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { width: 100%; height: 100vh; margin: 0; padding: 0; }
    .user-marker { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
    .user-marker .arrow {
      width: 28px; height: 28px;
      transform-origin: center center;
      transition: transform 0.25s ease-out;
    }
    #compass-btn {
      position: absolute;
      top: 12px; right: 12px;
      z-index: 1000;
      padding: 8px 10px;
      background: white;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 1px 6px rgba(0,0,0,0.12);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="compass-btn" style="display:none">Enable compass</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const radius = 250; // meters for tree search
    const fetchThreshold = 25; // meters before refetching trees
    const appToken = "8Y6BJoOEjSnxgyvODpDnOR5Yj";

    const map = L.map("map").setView([51.045, -114.071], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const treeLayer = L.layerGroup().addTo(map);

    let userMarker = null;
    let firstFix = true;
    let lastFetchLat = null;
    let lastFetchLon = null;
    let currentHeading = null; // smoothed heading

    function distanceMeters(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function createUserIcon() {
      const html = `
        <div class="user-marker">
          <svg class="arrow" viewBox="0 0 24 24">
            <path d="M12 2 L16 12 L12 9 L8 12 Z" fill="#007aff"/>
            <circle cx="12" cy="17" r="3" fill="#007aff"/>
          </svg>
        </div>`;
      return L.divIcon({ html, className: '', iconSize: [36,36], iconAnchor: [18,18] });
    }

    function smoothHeading(newHeading) {
      if (currentHeading === null) {
        currentHeading = newHeading;
        return newHeading;
      }
      let delta = newHeading - currentHeading;
      if (delta > 180) delta -= 360;
      if (delta < -180) delta += 360;
      currentHeading += delta * 0.15; // smoothing factor
      if (currentHeading < 0) currentHeading += 360;
      if (currentHeading >= 360) currentHeading -= 360;
      return currentHeading;
    }

    function updateUserMarker(lat, lon, heading) {
      if (!userMarker) {
        userMarker = L.marker([lat, lon], { icon: createUserIcon() }).addTo(map);
        userMarker.bindPopup("You are here");
      } else {
        userMarker.setLatLng([lat, lon]);
      }
      const el = userMarker.getElement && userMarker.getElement();
      if (el) {
        const arrow = el.querySelector('.arrow');
        if (arrow) {
          if (heading != null && !isNaN(heading)) {
            const smoothed = smoothHeading(heading);
            arrow.style.opacity = 1;
            arrow.style.transform = `rotate(${smoothed}deg)`;
          } else {
            arrow.style.opacity = 0.25;
          }
        }
      }
      if (firstFix) {
        map.setView([lat, lon], 16);
        userMarker.openPopup();
        firstFix = false;
      }
    }

    function loadTrees(lat, lon) {
      treeLayer.clearLayers();
      const url = `https://data.calgary.ca/resource/tfs4-3wwa.json?$$app_token=${appToken}&$where=within_circle(point, ${lat}, ${lon}, ${radius})&$limit=500`;
      fetch(url).then(r=>r.json()).then(data=>{
        if (!Array.isArray(data)) return;
        data.forEach(tree=>{
          if (tree.point && tree.point.coordinates) {
            const [tLon, tLat] = tree.point.coordinates;
            const m = L.circleMarker([tLat, tLon], { radius:5, color:"green", fillOpacity:0.7 }).addTo(treeLayer);
            m.bindPopup(`
              <b>${tree.common_name || tree.scientific_name || "Unknown"}</b><br>
              Asset ID: ${tree.asset_id || "N/A"}<br>
              Scientific Name: ${tree.scientific_name || "N/A"}<br>
              DBH (cm): ${tree.dbh_cm || "N/A"}<br>
              Mature Size: ${tree.mature_size || "N/A"}<br>
              Condition: ${tree.tree_condition_rating_perc || "N/A"}%
            `);
          }
        });
      });
    }

    // orientation handling
    function handleDeviceOrientation(e) {
      let heading = null;
      if (typeof e.webkitCompassHeading === 'number') {
        heading = e.webkitCompassHeading; // iOS: already clockwise from north
      } else if (typeof e.alpha === 'number') {
        heading = e.alpha; // Android: clockwise from north
      }
      if (heading != null && !isNaN(heading)) {
        const latlng = userMarker && userMarker.getLatLng();
        if (latlng) updateUserMarker(latlng.lat, latlng.lng, heading);
      }
    }

    function enableCompass() {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(res=>{
          if (res==='granted') {
            window.addEventListener('deviceorientation', handleDeviceOrientation, true);
            document.getElementById('compass-btn').style.display='none';
          }
        });
      } else {
        window.addEventListener('deviceorientation', handleDeviceOrientation, true);
        document.getElementById('compass-btn').style.display='none';
      }
    }

    // show compass button for iOS
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      document.getElementById('compass-btn').style.display='block';
      document.getElementById('compass-btn').addEventListener('click', enableCompass);
    } else {
      enableCompass();
    }

    // watch position
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const gpsHeading = (typeof pos.coords.heading === 'number') ? pos.coords.heading : null;
        updateUserMarker(lat, lon, gpsHeading);
        if (lastFetchLat===null || distanceMeters(lat,lon,lastFetchLat,lastFetchLon)>fetchThreshold) {
          lastFetchLat=lat; lastFetchLon=lon;
          loadTrees(lat, lon);
        }
      }, err=>{
        console.warn("Geolocation error:", err.message);
        if (lastFetchLat===null) loadTrees(51.045,-114.071);
      }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    } else {
      loadTrees(51.045,-114.071);
    }
  </script>
</body>
</html>
